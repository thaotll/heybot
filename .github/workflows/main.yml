name: Build, Scan & Update Manifests for ArgoCD

on: [push]

env:
  USER: "thaotll"
  IMAGE_NAME: "heybot-with-trivy-output"
  HELM_CHART_PATH: "./helm/heybot"
  HELM_RELEASE_NAME: "heybot"
  K8S_MANIFEST_PATH: "k8s"
  # Directory where CI scans will output results, relative to workspace root
  CI_SCAN_OUTPUT_DIR: "${{ github.workspace }}/ci_scan_output"

jobs:
  build_scan_and_update_manifests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          fetch-depth: 0

      - name: Get current commit ID
        id: get_commit_id
        run: echo "CURRENT_COMMIT_ID=$(git rev-parse HEAD)" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.11' # Match Dockerfile Python version

      - name: Install Python dependencies for scanning script
        run: pip install -r app/requirements.txt

      - name: Create directory for CI scan results
        run: mkdir -p ${{ env.CI_SCAN_OUTPUT_DIR }}

      - name: Run Security Scans (Trivy & OWASP via main.py - output to CI_SCAN_OUTPUT_DIR)
        id: security_scan_ci
        run: |
          echo "Running security scans locally for CI feedback and image baking..."
          # Ensure main.py writes its output to the CI_SCAN_OUTPUT_DIR
          # This might require main.py to accept an output path argument or use an env var.
          # For now, assuming main.py uses a relative path like 'analysis/' for output.
          # We will run it from a directory such that its output lands in CI_SCAN_OUTPUT_DIR
          # IMPORTANT: Adjust main.py or this step if main.py cannot easily redirect output.
          
          # Create a temporary app directory structure for main.py to run correctly
          mkdir -p temp_app_for_ci
          cp -r app/* temp_app_for_ci/
          # Create the target analysis directory *within* the structure main.py expects
          mkdir -p temp_app_for_ci/analysis 

          echo "Running python temp_app_for_ci/main.py..."
          # Execute main.py from within temp_app_for_ci so its relative paths work
          # Pass necessary secrets and config. DISCORD_WEBHOOK_URL might be optional here if only for feedback.
          (cd temp_app_for_ci && \
            CURRENT_COMMIT_ID=${{ env.CURRENT_COMMIT_ID }} \
            DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }} \
            MODEL_HUMOR_PATH=model_humor.txt \
            DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }} \
            python main.py)
          
          echo "Moving scan results from temp_app_for_ci/analysis to ${{ env.CI_SCAN_OUTPUT_DIR }}"
          # Move the results (e.g., latest.json, trivy json, owasp html) to CI_SCAN_OUTPUT_DIR
          # This assumes main.py placed its output into temp_app_for_ci/analysis/
          mv temp_app_for_ci/analysis/* ${{ env.CI_SCAN_OUTPUT_DIR }}/
          rm -rf temp_app_for_ci # Clean up temporary directory

          echo "Scan script finished. Listing contents of ${{ env.CI_SCAN_OUTPUT_DIR }}:"
          ls -lA ${{ env.CI_SCAN_OUTPUT_DIR }}

          LATEST_JSON_PATH="${{ env.CI_SCAN_OUTPUT_DIR }}/latest.json"
          if [ ! -f "$LATEST_JSON_PATH" ]; then
            echo "::error::Scan result file latest.json not found in ${{ env.CI_SCAN_OUTPUT_DIR }}!"
            echo "Expected at: $LATEST_JSON_PATH"
            # ls -lA ${{ env.CI_SCAN_OUTPUT_DIR }} # Double check content on error
            exit 1
          fi
          
          echo "Contents of latest.json:"
          cat "$LATEST_JSON_PATH"

          if jq -e '.securityScans[] | select(.status=="error")' "$LATEST_JSON_PATH"; then
            echo "::warning::Security scan found critical errors according to latest.json."
          elif jq -e '.securityScans[] | select(.status=="warning")' "$LATEST_JSON_PATH"; then
            echo "::warning::Security scan found warnings according to latest.json."
          else
            echo "Security scan completed without critical errors or warnings reported in latest.json."
          fi

      - name: Upload CI scan results (for debugging/archive)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-scan-results-${{ env.CURRENT_COMMIT_ID }}
          path: ${{ env.CI_SCAN_OUTPUT_DIR }}

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build and push Docker image (now includes scan results)
        run: |
          docker build --no-cache \
            --build-arg CURRENT_COMMIT_ID=${{ env.CURRENT_COMMIT_ID }} \
            -t ghcr.io/${{ env.USER }}/${{ env.IMAGE_NAME }}:${{ env.CURRENT_COMMIT_ID }} \
            -t ghcr.io/${{ env.USER }}/${{ env.IMAGE_NAME }}:latest .
          
          docker push ghcr.io/${{ env.USER }}/${{ env.IMAGE_NAME }}:${{ env.CURRENT_COMMIT_ID }}
          docker push ghcr.io/${{ env.USER }}/${{ env.IMAGE_NAME }}:latest

      - name: Update Kubernetes Manifests with Helm
        run: |
          echo "Updating image tag in Helm chart to ${{ env.CURRENT_COMMIT_ID }} for all relevant deployments"
          
          mkdir -p ${{ env.K8S_MANIFEST_PATH }}
          
          echo "Cleaning up previously Helm-generated files in ${{ env.K8S_MANIFEST_PATH }} that are managed by this chart"
          rm -f ${{ env.K8S_MANIFEST_PATH }}/deployment.yaml 
          rm -f ${{ env.K8S_MANIFEST_PATH }}/service.yaml
          rm -f ${{ env.K8S_MANIFEST_PATH }}/serviceaccount.yaml
          rm -f ${{ env.K8S_MANIFEST_PATH }}/_helpers.tpl 
          rm -f ${{ env.K8S_MANIFEST_PATH }}/NOTES.txt    
          rm -rf ${{ env.K8S_MANIFEST_PATH }}/tests       

          helm template ${{ env.HELM_RELEASE_NAME }} ./${{ env.HELM_CHART_PATH }} \
            --set image.tag=${{ env.CURRENT_COMMIT_ID }} \
            --set image.repository=ghcr.io/${{ env.USER }}/${{ env.IMAGE_NAME }} \
            --output-dir ${{ env.K8S_MANIFEST_PATH }}
            
          TEMPLATED_FILES_SOURCE_PATH="${{ env.K8S_MANIFEST_PATH }}/${{ env.HELM_RELEASE_NAME }}/templates"
          ALTERNATIVE_TEMPLATED_FILES_SOURCE_PATH="${{ env.K8S_MANIFEST_PATH }}/${{ env.HELM_RELEASE_NAME }}"

          if [ -d "$TEMPLATED_FILES_SOURCE_PATH" ]; then
            echo "Moving templated files from $TEMPLATED_FILES_SOURCE_PATH to ${{ env.K8S_MANIFEST_PATH }}"
            mv $TEMPLATED_FILES_SOURCE_PATH/* ${{ env.K8S_MANIFEST_PATH }}/
            rm -rf "${{ env.K8S_MANIFEST_PATH }}/${{ env.HELM_RELEASE_NAME }}"
          elif [ -d "$ALTERNATIVE_TEMPLATED_FILES_SOURCE_PATH" ]; then
            echo "Moving templated files from $ALTERNATIVE_TEMPLATED_FILES_SOURCE_PATH to ${{ env.K8S_MANIFEST_PATH }}"
            mv $ALTERNATIVE_TEMPLATED_FILES_SOURCE_PATH/* ${{ env.K8S_MANIFEST_PATH }}/
            rm -rf "${{ env.K8S_MANIFEST_PATH }}/${{ env.HELM_RELEASE_NAME }}"
          else
            echo "Error: Helm output directory not found as expected. Listing content of ${{ env.K8S_MANIFEST_PATH }} for debugging:"
            ls -R ${{ env.K8S_MANIFEST_PATH }}
            exit 1
          fi
          
          echo "Generated manifests in ${{ env.K8S_MANIFEST_PATH }}:"
          ls -R ${{ env.K8S_MANIFEST_PATH }}

      - name: Commit and push manifest changes
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          # Add the new PV and PVC files as well if they are in K8S_MANIFEST_PATH
          # or if they are top-level, adjust path. Assuming they are in k8s/ too.
          git add ${{ env.K8S_MANIFEST_PATH }}/*
          
          if ! git diff --staged --quiet; then
            git commit -m "Update image to ${{ env.IMAGE_NAME }}:${{ env.CURRENT_COMMIT_ID }} via Helm, add PV/PVC [skip ci]"
            git push
          else
            echo "No manifest changes to commit."
          fi